label: Liquibase
type: LiquibasePlugin
description: Execute liquibase changesets
cloudProvider: kubernetes
account: spinnaker
credentials: spinnaker
application: liquibase
waitForCompletion: true

manifest:
  apiVersion: batch/v1
  kind: Job
  metadata:
    name: liquibase-runner-100
  spec:
    template:
      spec:
        containers:
          - name: liquibase
            image: index.docker.io/mcred/lbspin:latest
            command: ["liquibase --classpath=/workspace/ --changeLogFile=samplechangelog.sql --url=jdbc:oracle:thin:app_schema/@oracle-kerberos.cz1j1vh9uvuo.us-east-1.rds.amazonaws.com:1521/ORCL status --verbose &&  echo \"======COMPLETED liquibase status =========\" && liquibase --classpath=/workspace/ --changeLogFile=samplechangelog.sql --url=jdbc:oracle:thin:app_schema/@oracle-kerberos.cz1j1vh9uvuo.us-east-1.rds.amazonaws.com:1521/ORCL validate  && echo \"======COMPLETED liquibase validate =========\" && liquibase --classpath=/workspace/ --changeLogFile=samplechangelog.sql --url=jdbc:oracle:thin:app_schema/@oracle-kerberos.cz1j1vh9uvuo.us-east-1.rds.amazonaws.com:1521/ORCL update &&  echo \"======COMPLETED liquibase update =========\" && liquibase --classpath=/workspace/ --changeLogFile=samplechangelog.sql --url=jdbc:oracle:thin:app_schema/@oracle-kerberos.cz1j1vh9uvuo.us-east-1.rds.amazonaws.com:1521/ORCL history  &&  echo \"======COMPLETED liquibase history =========\""]
            env:
                - name: JAVA_OPTS
                  value: -Djava.security.krb5.conf=/workspace/examples/krb5.conf -Doracle.net.kerberos5_cc_name=/workspace/examples/krb5cc -Dsun.security.krb5.debug=true -Doracle.net.kerberos5_mutual_authentication=true -Doracle.net.authentication_services=KERBEROS5
                - name: LB_HOST_NAME
                  value: lb-cs.datical.net
                - name: LB_HOST_IP
                  value: 172.30.1.13
                - name: CHANGELOG_REPO
                  value: https://github.com/adeelmalik78/lb-kerberos-spinnaker.git
                - name: CHANGELOG_BRANCH
                  value: main
        restartPolicy: Never
    ttlSecondsAfterFinished: 60
